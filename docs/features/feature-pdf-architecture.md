---
feature: pdf
type: architecture
scope: PDF Extraction & Generation (V2 Pipeline)
updated: 2026-02-13
---

# PDF Feature Architecture

## Data Model

### Core Entities

| Entity | Fields | Type | Notes |
|--------|--------|------|-------|
| **ParsedBidItem** | itemNumber, description, unit, quantity, unitPrice, bidAmount, confidence, warnings | Model | Extracted from PDF; confidence 0.0-1.0 |
| **QualityReport** | documentProfile, extractionMetrics, validationResults, overallConfidence, requiredReview | Model | Quality assessment post-extraction |
| **PipelineConfig** | ocrDpi, tesseractPsmMode, amountTolerance, enableInference, enableSplitting, hasEncodingCorruption | Config | Per-document OCR settings |
| **ExtractionMetrics** | pagesProcessed, itemsExtracted, itemsValidated, avgConfidence, processingTimeMs | Metrics | Performance tracking |

### Key Models

**ParsedBidItem**:
- Generated by extraction pipeline (stages 0-6)
- Stored in SQLite (bid_items table)
- May be inferred (quantity/unitPrice calculated from amount) or split (multi-item rows)
- Confidence drives UI behavior: < 0.6 requires review, 0.6-0.8 shows warning, > 0.8 auto-accepted

**QualityReport**:
- Generated by stage 6 (quality_validator)
- Documents: CMap corruption status, extraction coverage, missing items, duplicate detection
- Used to determine if user review is required before data import

## Relationships

### PDF → Bid Items (1-N)
```
PDF Page (rendered to image)
    ├─→ Stage 0: Document analyzer (detects page structure, CMap corruption)
    ├─→ Stage 1: Page renderer (OCR rendering at DPI/PSM config)
    ├─→ Stage 2: Native extractor (legacy; skipped in V2)
    ├─→ Stage 3: Structure preserver (detect columns, rows)
    ├─→ Stage 4: Data extractor (parse cells to bid items)
    ├─→ Stage 5: Post-processor (inference, splitting, deduplication)
    └─→ Stage 6: Quality validator (confidence scoring, report generation)
            ↓
        ParsedBidItem[] (1 to N items per page)
            ↓
        SQLite bid_items table
```

### PDF → DailyEntry (1-1)
```
PDF File (external)
    ↓
Project's Bid Document (metadata stored in projects table)
    ↓
DailyEntry.bidItems[] (references parsed items)
```

## Repository Pattern

### Extraction Pipeline

**ExtractionPipeline** (`lib/features/pdf/services/extraction/pipeline/extraction_pipeline.dart`):
- Orchestrates all 7 stages (0-6)
- Methods:
  - `extractFromPdf(File pdf, PipelineConfig config) → Future<(List<ParsedBidItem>, QualityReport)>`
  - `extractPage(PdfPage page, PipelineConfig config) → Future<List<ParsedBidItem>>`
  - `getMetrics() → ExtractionMetrics`

**Individual Stages**:
- Stage 0: `DocumentAnalyzer.analyzeProfile()` - Detects structure, CMap corruption
- Stage 1: `PageRendererV2.renderPage()` - Tesseract OCR at configurable DPI/PSM
- Stage 3: `StructurePreserver.detectLayout()` - Multi-column detection
- Stage 4: `DataExtractor.extractCells()` - Raw text→ structured data
- Stage 5: `PostProcessor.inferAndSplit()` - Field inference, row splitting, deduplication
- Stage 6: `QualityValidator.validate()` - Confidence scoring, report generation

### PDF Generation

**PdfService** (`lib/features/pdf/data/services/pdf_generation_service.dart`):
- Methods:
  - `fillTemplate(File template, Map<String, String> data) → Future<Uint8List>`
  - `generateInspectionReport(Project project, DailyEntry entry) → Future<Uint8List>`

**FormFieldMappings** (`lib/features/pdf/data/services/form_field_mappings.dart`):
- Static map: UI field name → PDF template field name
- Example: `'projectName' → 'project_name'` (in template)

## State Management

### Provider Type: ChangeNotifier

**PdfExtractionProvider** (`lib/features/pdf/presentation/providers/`):
- `currentPdf: File?` - Selected PDF file
- `extractionProgress: double` - 0.0-1.0 progress indicator
- `extractedItems: List<ParsedBidItem>` - Results after extraction
- `qualityReport: QualityReport?` - Validation results
- `isLoading: bool` - Extraction in progress
- `error: String?` - Error message if extraction failed

Methods:
- `selectPdfFile(File pdf)` - Load and validate PDF
- `startExtraction(PipelineConfig config)` - Begin pipeline
- `validateItems()` - Run quality checks
- `importToDailyEntry(DailyEntry entry)` - Save to database

### Lifecycle

```
User selects PDF → Provider loads file
    ↓
selectPdfFile() called → isLoading=true
    ↓
DocumentAnalyzer runs → progress updated
    ↓
ExtractionPipeline runs all stages → extractedItems populated
    ↓
QualityValidator runs → qualityReport populated, isLoading=false
    ↓
UI shows results + confidence warnings
    ↓
User confirms → importToDailyEntry() saves to SQLite
```

## Offline Behavior

**Fully offline**: Extraction, parsing, and report generation occur locally without network access.

### Read Path (Offline)
- PDF files accessed from device storage
- Bid item data read from local SQLite
- No cloud dependency

### Write Path (Offline)
- Extracted items written to SQLite immediately
- Reports stored as files on device
- Sync queued for later when connectivity available (if enabled)

### Sync Status
- Extracted bid items tagged with `syncStatus: pending` until synced
- DailyEntry references mark entries as pending when they reference unsynced bid items
- Sync adapter pushes local items to Supabase during `syncAll()` or `syncEntry()`

## Testing Strategy

### Unit Tests (Stage-level)
- **Stage 0**: Document profile detection (CMap corruption, multi-column)
- **Stage 1**: Page rendering (OCR output validation against ground truth)
- **Stage 3-6**: Layout detection, cell extraction, inference, deduplication

Location: `test/features/pdf/extraction/stages/`

### Integration Tests (Pipeline-level)
- **Full pipeline**: Load Springfield PDF → extract → validate
- **Re-extraction loop**: Verify 3 attempts with different DPI/PSM configs
- **Quality validator**: Confidence scoring against expected items

Location: `test/features/pdf/extraction/integration/full_pipeline_integration_test.dart`

### Golden Fixtures
- **springfield_golden_test.dart**: Defines ground truth (131 items, expected fields)
- **Fixtures**: JSON snapshots for each stage output (stages 0-6)
- **Benchmark**: Performance tracking for each DPI/PSM variant

Location: `test/features/pdf/extraction/fixtures/` and `test/features/pdf/extraction/golden/`

### Test Contracts (Stage Boundaries)
- Stage 0→1: Document profile output matches input PDF type
- Stage 1→2: OCR text captured accurately
- Stage 3→4: Column detection preserves item relationships
- Stage 4→5: Raw cells convert to structured items
- Stage 5→6: Inference + splitting produces expected item count
- Stage 6 output: QualityReport confidence matches ground truth

### Coverage Target
- ≥ 90% for all extraction stages
- 100% coverage for confidence scoring logic
- All public methods tested (happy path + error paths)

## Performance Considerations

### Target Response Times (Soft Guidelines)
- Single-page PDF: < 15 seconds (including OCR)
- Multi-page (10+): < 3 seconds per page average
- Re-extraction loop (3 attempts): < 45 seconds total

### Memory Constraints
- Page rendering (image buffers): ~5-10 MB per page
- OCR session: ~50-100 MB (Tesseract heap)
- Large PDFs: Process in chunks to avoid OOM

### Optimization Opportunities
- Parallel page processing (if Tesseract allows)
- Incremental quality validation (fail fast on low confidence)
- Lazy confidence scoring (defer until import time)

## File Locations

```
lib/features/pdf/
├── data/
│   ├── models/
│   │   ├── parsed_bid_item.dart
│   │   └── quality_report.dart
│   └── services/
│       ├── pdf_generation_service.dart
│       └── form_field_mappings.dart
│
├── presentation/
│   ├── screens/
│   │   └── pdf_preview_screen.dart
│   ├── widgets/
│   │   ├── extracted_items_list.dart
│   │   └── quality_report_widget.dart
│   └── providers/
│       └── pdf_extraction_provider.dart
│
└── services/
    └── extraction/
        ├── pipeline/
        │   ├── extraction_pipeline.dart
        │   └── extraction_metrics.dart
        │
        ├── stages/
        │   ├── stage_0_document_analyzer.dart
        │   ├── stage_1_page_renderer_v2.dart
        │   ├── stage_3_structure_preserver.dart
        │   ├── stage_4_data_extractor.dart
        │   ├── stage_5_post_processor.dart
        │   └── stage_6_quality_validator.dart
        │
        ├── models/
        │   ├── pipeline_config.dart
        │   └── extraction_context.dart
        │
        ├── ocr/
        │   └── tesseract_wrapper.dart
        │
        └── deprecated/
            └── [V1 code - do not use]

assets/templates/
├── daily_inspection_report.pdf
└── [other templates]
```

### Import Pattern

```dart
// Within PDF feature
import 'package:construction_inspector/features/pdf/services/extraction/pipeline/extraction_pipeline.dart';
import 'package:construction_inspector/features/pdf/data/models/parsed_bid_item.dart';

// From other features
import 'package:construction_inspector/features/pdf/presentation/providers/pdf_extraction_provider.dart';
```
