---
feature: pdf
type: architecture
scope: PDF Extraction & Generation (V2 Pipeline)
updated: 2026-02-13
---

# PDF Feature Architecture

## Data Model

### Core Entities

| Entity | Fields | Type | Notes |
|--------|--------|------|-------|
| **ParsedBidItem** | itemNumber, description, unit, quantity, unitPrice, bidAmount, confidence, warnings | Model | Extracted from PDF; confidence 0.0-1.0 |
| **QualityReport** | documentProfile, extractionMetrics, validationResults, overallConfidence, requiredReview | Model | Quality assessment post-extraction |
| **PipelineConfig** | ocrDpi, tesseractPsmMode, amountTolerance, enableInference, enableSplitting, hasEncodingCorruption | Config | Per-document OCR settings |
| **ExtractionMetrics** | pagesProcessed, itemsExtracted, itemsValidated, avgConfidence, processingTimeMs | Metrics | Performance tracking |

### Key Models

**ParsedBidItem**:
- Generated by the V2 extraction pipeline (DocumentQualityProfiler through QualityValidator)
- Stored in SQLite (bid_items table)
- May be inferred (quantity/unitPrice calculated from amount) or split (multi-item rows)
- Confidence drives UI behavior: < 0.6 requires review, 0.6-0.8 shows warning, > 0.8 auto-accepted

**QualityReport**:
- Generated by `QualityValidator` (final extraction stage)
- Documents: CMap corruption status, extraction coverage, missing items, duplicate detection
- Used to determine if user review is required before data import

## Relationships

### PDF → Bid Items (1-N)
```
PDF Page (rendered to image)
    ├─→ DocumentQualityProfiler   (detects page structure, CMap corruption, scan quality)
    ├─→ ImagePreprocessorV2       (denoising, deskew, contrast; GridLineRemover applied here)
    ├─→ PageRendererV2            (renders to image at target DPI)
    ├─→ TextRecognizerV2          (Tesseract OCR → OcrElement list)
    ├─→ RegionDetectorV2          (locates table regions)
    ├─→ ColumnDetectorV2          (column boundary detection)
    ├─→ CellExtractorV2           (grid cell extraction)
    ├─→ RowClassifierV3           (header / data / continuation classification)
    ├─→ RowMerger                 (merges multi-line rows)
    ├─→ RowParserV3               (typed field parsing via rules/)
    ├─→ NumericInterpreter        (currency, quantity interpretation)
    ├─→ PostProcessorV2           (inference, splitting, deduplication)
    └─→ QualityValidator          (confidence scoring, report generation)
            ↓
        ParsedBidItem[] (1 to N items per page)
            ↓
        SQLite bid_items table
```

### PDF → DailyEntry (1-1)
```
PDF File (external)
    ↓
Project's Bid Document (metadata stored in projects table)
    ↓
DailyEntry.bidItems[] (references parsed items)
```

## Repository Pattern

### Extraction Pipeline

**ExtractionPipeline** (`lib/features/pdf/services/extraction/pipeline/extraction_pipeline.dart`):
- Orchestrates all extraction stages (DocumentQualityProfiler through QualityValidator)
- Methods:
  - `extractFromPdf(File pdf, PipelineConfig config) → Future<(List<ParsedBidItem>, QualityReport)>`
  - `extractPage(PdfPage page, PipelineConfig config) → Future<List<ParsedBidItem>>`
  - `getMetrics() → ExtractionMetrics`

**Individual Stages**:
- `DocumentQualityProfiler.analyzeProfile()` - Detects structure, CMap corruption, scan quality
- `ImagePreprocessorV2.preprocess()` + `GridLineRemover.remove()` - Image cleanup before OCR
- `PageRendererV2.renderPage()` - Renders PDF page to image at target DPI
- `TextRecognizerV2.recognize()` - Tesseract OCR at configurable DPI/PSM, returns OcrElement list
- `ColumnDetectorV2.detectColumns()` + `CellExtractorV2.extract()` - Column/cell detection
- `RowClassifierV3.classify()` + `RowMerger.merge()` + `RowParserV3.parse()` - Row interpretation
- `PostProcessorV2.process()` - Field inference, row splitting, deduplication
- `QualityValidator.validate()` - Confidence scoring, report generation

### PDF Generation

**PdfService** (`lib/features/pdf/services/pdf_service.dart`):
- Generates IDR (Inspector's Daily Report) PDF using Syncfusion templates
- Embeds entry data, contractor lists, quantities, and photo pages
- Delegates photo page rendering to `PhotoPdfService`

**PhotoPdfService** (`lib/features/pdf/services/photo_pdf_service.dart`):
- Renders photo pages within IDR reports
- Handles image scaling and caption layout

**PdfImportService** (`lib/features/pdf/services/pdf_import_service.dart`):
- Orchestrates the extraction pipeline for imported pay-item PDFs
- Returns `PdfImportResult` containing `List<ParsedBidItem>` and `List<BidItem>`

## State Management

### Provider Type: ChangeNotifier

PDF import state is managed imperatively via `PdfImportHelper` and `PdfImportProgressManager` rather than a dedicated ChangeNotifier provider.

**PdfImportProgressManager** (`lib/features/pdf/presentation/widgets/pdf_import_progress_manager.dart`):
- Manages progress state during a single import run
- Drives `PdfImportProgressDialog` with stage-level updates

**PdfImportHelper** (`lib/features/pdf/presentation/helpers/pdf_import_helper.dart`):
- Static entry point for import flows: file picker → progress dialog → `PdfImportService` → result
- Used by `ProjectSetupScreen` and any screen that triggers pay-item import

### Lifecycle

```
User selects PDF → PdfImportHelper.importFromPdf()
    ↓
FilePicker selects file → PdfImportProgressDialog shown
    ↓
PdfImportService.importFromPdf() → ExtractionPipeline runs all stages
    ↓
DocumentQualityProfiler → preprocessing → OCR → cell/row extraction
    ↓
PostProcessorV2 → QualityValidator → PdfImportResult returned
    ↓
pdf_import_preview_screen.dart shows items + confidence warnings
    ↓
User confirms → BidItem list saved to SQLite via DatabaseService
```

## Offline Behavior

**Fully offline**: Extraction, parsing, and report generation occur locally without network access.

### Read Path (Offline)
- PDF files accessed from device storage
- Bid item data read from local SQLite
- No cloud dependency

### Write Path (Offline)
- Extracted items written to SQLite immediately
- Reports stored as files on device
- Sync queued for later when connectivity available (if enabled)

### Sync Status
- Extracted bid items tagged with `syncStatus: pending` until synced
- DailyEntry references mark entries as pending when they reference unsynced bid items
- Sync adapter pushes local items to Supabase during `syncAll()` or `syncEntry()`

## Testing Strategy

### Unit Tests (Stage-level)
- **DocumentQualityProfiler**: Document profile detection (CMap corruption, scan quality)
- **PageRendererV2 / TextRecognizerV2**: Page rendering and OCR output validation against ground truth
- **ColumnDetectorV2, CellExtractorV2, RowClassifierV3**: Layout detection and cell extraction
- **PostProcessorV2, QualityValidator**: Inference, deduplication, confidence scoring

Location: `test/features/pdf/extraction/stages/`

### Integration Tests (Pipeline-level)
- **Full pipeline**: Load Springfield PDF → extract → validate
- **Re-extraction loop**: Verify 3 attempts with different DPI/PSM configs
- **Quality validator**: Confidence scoring against expected items

Location: `test/features/pdf/extraction/integration/full_pipeline_integration_test.dart`

### Golden Fixtures
- **springfield_golden_test.dart**: Defines ground truth (131 items, expected fields)
- **Fixtures**: JSON snapshots for each stage output (quality profiler through post-processor)
- **Benchmark**: Performance tracking for each DPI/PSM variant

Location: `test/features/pdf/extraction/fixtures/` and `test/features/pdf/extraction/golden/`

### Test Contracts (Stage Boundaries)
- DocumentQualityProfiler → preprocessors: Document profile output matches input PDF characteristics
- TextRecognizerV2 output: OCR text captured accurately against ground truth
- ColumnDetectorV2 → CellExtractorV2: Column detection preserves item relationships
- CellExtractorV2 → RowParserV3: Raw cells convert to structured typed items
- PostProcessorV2 output: Inference + splitting produces expected item count
- QualityValidator output: QualityReport confidence matches ground truth

### Coverage Target
- ≥ 90% for all extraction stages
- 100% coverage for confidence scoring logic
- All public methods tested (happy path + error paths)

## Performance Considerations

### Target Response Times (Soft Guidelines)
- Single-page PDF: < 15 seconds (including OCR)
- Multi-page (10+): < 3 seconds per page average
- Re-extraction loop (3 attempts): < 45 seconds total

### Memory Constraints
- Page rendering (image buffers): ~5-10 MB per page
- OCR session: ~50-100 MB (Tesseract heap)
- Large PDFs: Process in chunks to avoid OOM

### Optimization Opportunities
- Parallel page processing (if Tesseract allows)
- Incremental quality validation (fail fast on low confidence)
- Lazy confidence scoring (defer until import time)

## File Locations

```
lib/features/pdf/
├── pdf.dart                              # Feature barrel export
│
├── data/
│   └── models/
│       ├── models.dart                   # Barrel export
│       └── parsed_bid_item.dart          # Extracted bid item with confidence/warnings
│
├── presentation/
│   ├── helpers/
│   │   ├── pdf_import_helper.dart        # Shared helper: file picker + progress UI + error handling
│   │   └── mp_import_helper.dart         # MP-format import helper
│   ├── screens/
│   │   ├── screens.dart                  # Barrel export
│   │   ├── pdf_import_preview_screen.dart # Preview/review extracted items before import
│   │   └── mp_import_preview_screen.dart  # Preview screen for MP-format PDFs
│   └── widgets/
│       ├── widgets.dart                  # Barrel export
│       ├── pdf_import_progress_dialog.dart # Progress dialog shown during extraction
│       └── pdf_import_progress_manager.dart # Manages progress state across import flow
│
└── services/
    ├── services.dart                     # Barrel export
    ├── pdf_service.dart                  # IDR generation: fills Syncfusion PDF templates for daily reports
    ├── pdf_import_service.dart           # Orchestrates ExtractionPipeline → ParsedBidItem → BidItem
    ├── photo_pdf_service.dart            # Embeds photos into PDF report pages
    │
    ├── mp/
    │   ├── mp_models.dart                # Data models for MP-format pay item PDFs
    │   └── mp_extraction_service.dart    # Extracts pay items from MP-format PDFs (uses V2 OCR stages)
    │
    └── extraction/
        ├── pipeline/
        │   ├── extraction_pipeline.dart  # Orchestrates all extraction stages end-to-end
        │   ├── pipeline_context.dart     # Shared mutable context passed between stages
        │   ├── extraction_metrics.dart   # Tracks timing, item counts, confidence per run
        │   ├── result_converter.dart     # Converts V2 extraction models → ParsedBidItem / BidItem
        │   ├── coordinate_normalizer.dart # Normalizes OCR bounding boxes to logical coordinates
        │   └── confidence_model.dart     # Confidence scoring formulas shared across stages
        │
        ├── stages/
        │   ├── stages.dart               # Barrel export
        │   ├── stage_names.dart          # String constants for stage identifiers
        │   ├── stage_fixtures.dart       # Fixture serialization helpers for integration tests
        │   ├── document_quality_profiler.dart # Detects document structure, CMap corruption, scan quality
        │   ├── image_preprocessor_v2.dart     # OpenCV-style denoising, deskew, contrast enhancement
        │   ├── grid_line_remover.dart         # Removes table grid lines before OCR
        │   ├── page_renderer_v2.dart          # Renders PDF page to image at configurable DPI
        │   ├── text_recognizer_v2.dart        # Runs Tesseract OCR, returns raw OcrElement list
        │   ├── region_detector_v2.dart        # Detects table regions within OCR element set
        │   ├── column_detector_v2.dart        # Detects column boundaries from OCR layout
        │   ├── grid_line_detector.dart        # Detects grid lines to aid column/row segmentation
        │   ├── cell_extractor_v2.dart         # Extracts individual cells from column/row grid
        │   ├── row_classifier_v2.dart         # Classifies rows as header, data, or continuation
        │   ├── row_classifier_v3.dart         # Refined row classifier with improved heuristics
        │   ├── row_merger.dart                # Merges multi-line rows into single logical rows
        │   ├── row_parser_v3.dart             # Parses merged rows into typed field values
        │   ├── header_consolidator.dart       # Consolidates multi-line column headers
        │   ├── numeric_interpreter.dart       # Interprets numeric cell values (currency, quantities)
        │   ├── field_confidence_scorer.dart   # Scores confidence per extracted field
        │   ├── element_validator.dart         # Validates OcrElement geometry and text quality
        │   ├── post_processor_v2.dart         # Field inference, row splitting, deduplication
        │   └── quality_validator.dart         # Produces QualityReport with overall confidence
        │
        ├── ocr/
        │   ├── ocr.dart                  # Barrel export
        │   ├── ocr_engine_v2.dart        # OCR engine interface (Tesseract v2 adapter)
        │   ├── tesseract_engine_v2.dart  # Flusseract wrapper with HOCR output support
        │   └── tesseract_config_v2.dart  # PSM mode, DPI, language config for V2 engine
        │
        ├── rules/
        │   ├── text_rules.dart           # Interpretation rules for text fields
        │   ├── numeric_rules.dart        # Interpretation rules for numeric fields
        │   ├── currency_rules.dart       # Interpretation rules for currency fields
        │   └── interpretation_patterns.dart # Shared regex patterns for field parsing
        │
        ├── shared/
        │   ├── unit_registry.dart        # Known unit-of-measure strings for normalization
        │   ├── header_keywords.dart      # Keywords that identify column headers
        │   ├── extraction_patterns.dart  # Regex patterns for item numbers, amounts, etc.
        │   ├── field_format_validator.dart # Validates field formats before acceptance
        │   ├── post_process_utils.dart   # Shared deduplication and splitting utilities
        │   ├── text_quality_analyzer.dart # Scores OCR text quality for confidence gating
        │   ├── math_utils.dart           # Cross-multiplication backsolve for field inference
        │   ├── crop_upscaler.dart        # DPI-target crop upscaling for low-res regions
        │   └── quality_thresholds.dart   # Confidence threshold constants
        │
        └── models/
            ├── models.dart               # Barrel export
            ├── pipeline_config.dart      # Per-run OCR settings (DPI, PSM, tolerances)
            ├── document_profile.dart     # DocumentProfile output from quality profiler
            ├── extraction_result.dart    # Final result container from pipeline
            ├── ocr_element.dart          # Single OCR word/line with bounding box
            ├── detected_regions.dart     # Table region boundaries detected on page
            ├── column_map.dart           # Column boundary definitions
            ├── cell_grid.dart            # 2D grid of extracted cell text values
            ├── classified_rows.dart      # Rows after classifier assigns row type
            ├── grid_lines.dart           # Detected grid line positions
            ├── parsed_items.dart         # Items after row parsing (pre-post-processing)
            ├── processed_items.dart      # Items after post-processing (ready for review)
            ├── quality_report.dart       # QualityReport: coverage, confidence, review flag
            ├── stage_report.dart         # Per-stage timing and output summary
            ├── sidecar.dart              # Sidecar metadata attached to extraction run
            ├── document_checksum.dart    # Checksum for detecting re-extraction of same doc
            ├── confidence.dart           # Confidence value type with range enforcement
            ├── interpreted_value.dart    # Typed value after rule application
            └── interpretation_rule.dart  # Rule definition for field interpretation
```

### Import Pattern

```dart
// Within PDF feature (extraction pipeline)
import 'package:construction_inspector/features/pdf/services/extraction/pipeline/extraction_pipeline.dart';
import 'package:construction_inspector/features/pdf/data/models/parsed_bid_item.dart';

// Triggering import from another feature (e.g. project setup)
import 'package:construction_inspector/features/pdf/presentation/helpers/pdf_import_helper.dart';
import 'package:construction_inspector/features/pdf/services/pdf_import_service.dart';
```
