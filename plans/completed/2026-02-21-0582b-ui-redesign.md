# 0582B UI Redesign Plan (v2)

**Date:** 2026-02-21
**Status:** Pending Approval
**Session:** 424 (comprehensive rewrite of Session 418 plan)
**Scope:** Complete UI/UX redesign of 0582B form system — three-view architecture with 3 quick-entry screens, integrated OnePointCalculator (Michigan Cone), full form fields, efficient data flows, bug fixes.
**Supersedes:** Session 418 plan (v1), `.claude/plans/2026-02-20-0582b-form-redesign.md` (Phases 3-6)

---

## Decisions Made

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Primary use | Phone/tablet in the field | Touch-friendly, large targets, clear hierarchy |
| Row layout | Labeled card per row, vertical stacking | Most readable, persistent labels, big touch targets |
| Input method | SmartInputBar (fixed, improved) | Bottom bar with field highlight, auto-save on switch, actual Next advancement |
| Architecture | Three-view system + 3 entry screens | Daily entry = data hub, 3 focused entry screens, form screen = viewer/reviewer |
| Data entry points | 3 buttons: + Test, + Proctor, + Weights | Each opens focused quick-entry screen from daily entry form card |
| Chart type | Michigan Cone only (hardcoded) | Team always uses Cone. No selector needed. T-99 tables exist in decoded algorithm for future if needed |
| MDD/OMC computation | Auto-compute on input | As soon as proctor inputs are entered, MDD and OMC auto-fill instantly via OnePointCalculator |
| Proctor-to-test linking | Chip bar on Quick Test Entry | Auto-select if 1 proctor, chip picker if multiple. Test row stores `proctor_number` reference |
| No-proctor behavior | Block test entry with prompt | Show "No proctor yet — add one first?" with button to Proctor Entry. Send to Form disabled |
| Out-of-bounds input | Block proctor save until valid | Calculator must produce valid MDD/OMC before Save is enabled |
| 20/10 weights | Per-proctor, tied to proctor row | Latest proctor uses 5-slot table on PDF. Older proctors' weights go to remarks |
| Weight readings | Start with 2, expand to 5 | Most consolidation achieved in 2-3 attempts. "+ Add Reading" button |
| Test row groups | 3 groups: Gauge + Density + Location | Mirrors PDF columns left-to-right as sections top-to-bottom |
| Display order | Header > Tests > Proctor > 20/10 Weights | Matches paper form, familiar to inspectors |
| Row editability | Always editable | Fast corrections in the field |
| Rechecks | Simple toggle (original/recheck) | Rare occurrence, don't over-engineer |

---

## Domain Reference

### MDOT 0582B Form Structure (from Density Testing Manual 2024)

**Source**: `Pre-devolopment and brainstorming/Form Templates for export/Density-Testing-Inspection-Manual.pdf`

#### Header (10 fields)
- Date, Control Section ID, Job Number, Route Number/Street, Gauge Number
- Density Inspector, Certification Number, Phone Number, Construction Eng (MDOT), Asst. Con. Eng/Consultant Eng

#### Main Table: "Determination of In-Place Density" (16 columns per test row)
| Col | Label | Source | Type |
|-----|-------|--------|------|
| 1 | Original/Recheck | Inspector marks | Toggle |
| 2 | (empty in this table, but test number) | Sequential | Auto |
| 3 | Test Depth (inch) | Inspector reads gauge | Numeric |
| 4 | Counts (MC) | Gauge display | Numeric |
| 5 | Counts (DC) | Gauge display | Numeric |
| 6 | Dry Density PCF | Gauge display | Numeric |
| 7 | Wet Density PCF | Gauge display | Numeric |
| 8 | Moisture PCF | Gauge display | Numeric |
| 9 | Moisture % | Gauge display | Numeric |
| 10 | Max Density PCF | **Auto from proctor** (OnePointCalculator) | Auto |
| 11 | Percent of Compaction | Calculated: (Dry Density / Max Density) x 100 | Calc |
| 12 | Station | Inspector | Text |
| 13 | Distance from CL - Left (ft) | Inspector | Numeric |
| 14 | Distance from CL - Right (ft) | Inspector | Numeric |
| 15 | Depth Below Plan Grade (ft) | Inspector | Numeric |
| 16 | Item of Work | Inspector | Dropdown |

#### Second Table: "Determination of Maximum Density (Soil & HMA)" (10 columns)
| Col | Label | Source | Type |
|-----|-------|--------|------|
| A | Test Number | Sequential | Auto |
| B | Moisture % | Speedy tester or gauge | Numeric |
| C | Volume Mold (cu ft) | Painted on mold | Numeric |
| D | Wet Soil + Mold (g) | Scale reading | Numeric |
| E | Mold (g) | Painted on mold | Numeric |
| F | Wet Soil (g) | Calculated: D - E | Calc |
| G | Wet Soil (lbs) | Calculated: F / 453.59 | Calc |
| H | Compacted Soil Wet PCF | Calculated: G / C | Calc |
| I | Max Density PCF | **Auto from OnePointCalculator** | Auto |
| J | Optimum Moisture % | **Auto from OnePointCalculator** | Auto |

#### 20/10 Weights (per-proctor)
- Variable number of gram readings (typically 2-3, up to 5)
- **20/10 Rule**: After cone compaction, add material + pound 20 more times. Re-weigh. If increase <= 10g, consolidation achieved. Otherwise repeat.
- App validates: delta between consecutive readings <= 10g = pass
- **Per-proctor**: Each proctor has its own set of 20/10 weight readings
- **PDF output**: Latest proctor's weights use the 5-slot table. Older proctors' weights go to Remarks section as `Proctor #N 20/10: 1) xxxx 2) xxxx 3) xxxx`

#### Footer
- Chart Standards: Density / Moisture (from gauge book)
- Operating Standards: Density / Moisture (daily standard count)
- Remarks (free text + auto-appended older proctor weights)
- Agency/Company

### Calculation Chain
```
PROCTOR TABLE (field-calculated + OnePointCalculator):
  Wet Soil (g) = Wet Soil+Mold (g) - Mold (g)           [Col F = D - E]
  Wet Soil (lbs) = Wet Soil (g) / 453.59                 [Col G = F / 453.59]
  Compacted Wet PCF = Wet Soil (lbs) / Volume Mold       [Col H = G / C]
  ── OnePointCalculator (Michigan Cone) ──
  INPUT: moisture_percent (Col B), compacted_wet_pcf (Col H)
  OUTPUT: Max Density (Col I), Optimum Moisture (Col J)

TEST ROW (per nuclear gauge test):
  Max Density = copied from linked proctor row
  Dry Density = Wet Density / (1 + Moisture% / 100)       [Existing calc]
  % Compaction = (Dry Density / Max Density) x 100         [Existing calc]

20/10 VALIDATION (per-proctor):
  For each consecutive pair: abs(reading[n] - reading[n-1]) <= 10g = pass
```

### OnePointCalculator: Michigan Cone Algorithm

**Source**: Reverse-engineered from MDOT `com.JacobArmour.ConstructionDensity` APK
**Algorithm doc**: `tools/mdot-apk/decoded_algorithm.md`
**Verified**: 14/14 ground truth points, max error 0.08 pcf MDD, 0.06% OMC

#### Constants
```
VOLUME_FACTOR = 16.0184633796014  // pcf -> kg/m3 conversion
```

#### Algorithm Steps
1. Convert inputs to internal units (kg/m3): `wetDensity_internal = compacted_wet_pcf * VOLUME_FACTOR`
2. Validate inputs via `coneTestValidate(moisture, wetDensity_internal)`
3. Find dry density via `coneDryDensity(moisture, wetDensity_internal)` — 21-row lookup table with linear interpolation
4. Compute OMC via `coneOptimumMoisture(dryDensity_internal)` — cubic polynomial
5. Convert back: `MDD_pcf = dryDensity_internal / VOLUME_FACTOR`
6. Return `{ maxDensityPcf, optimumMoisturePct }`

#### Cone Family Curve Table (21 rows)
Each row defines a straight line in (moisture, wetDensity_kg/m3) space:
`wetDensity = slope * moisture + intercept`

| Row | Slope | Intercept | BoundaryDD |
|-----|-------|-----------|------------|
| 0 | 70.329387 | 2140.278864 | 2409.20105 |
| 1 | 67.39264 | 2096.837882 | 2362.74704 |
| 2 | 65.136956 | 2047.490712 | 2319.496755 |
| 3 | 59.315143 | 2021.346377 | 2269.839021 |
| 4 | 52.060528 | 2006.332656 | 2223.385011 |
| 5 | 45.193528 | 1996.826522 | 2176.931002 |
| 6 | 38.444698 | 1991.114963 | 2132.078854 |
| 7 | 31.417172 | 1993.457472 | 2087.226707 |
| 8 | 25.943565 | 1991.692955 | 2045.578285 |
| 9 | 23.221243 | 1966.458959 | 1999.124275 |
| 10 | 22.852605 | 1922.523974 | 1959.077715 |
| 11 | 21.857671 | 1880.483112 | 1915.82743 |
| 12 | 22.049599 | 1828.88395 | 1870.975283 |
| 13 | 21.209469 | 1790.78078 | 1829.326861 |
| 14 | 20.02328 | 1758.043984 | 1786.076576 |
| 15 | 19.466341 | 1720.172138 | 1747.631878 |
| 16 | 18.972578 | 1681.207873 | 1710.789043 |
| 17 | 18.48766 | 1645.684779 | 1675.54807 |
| 18 | 18.364932 | 1603.991458 | 1638.705235 |
| 19 | 18.257304 | 1561.482002 | 1603.464262 |
| 20 | 18.156393 | 1518.363492 | 1569.825152 |

BoundaryDD range: 1569.8 (98.0 pcf) to 2409.2 (150.4 pcf)

#### Cone OMC Polynomial
```
OMC = 1.194392432e-09 * dd^3 + 5.458657796e-06 * dd^2 - 0.052831877178 * dd + 84.758177133534
```
Where `dd` = dry density in kg/m3 (internal units).

#### Cone Validation
```
moisture: 5.0 <= m <= 20.0
wetDensity: checked against reciprocal polynomial upper boundary
upperBound = (((-2795547.646/m + 1557631.443)/m - 319202.5737)/m + 33028.87)/m + 844.44
```

#### Dry Density Interpolation Algorithm
1. For each curve i (0 to 20): compute `line_i = slope[i] * moisture + intercept[i]`
2. Find first curve i where `line_i + 1.0 >= wetDensity_internal`
3. Linear interpolation between curves i-1 and i:
   - `fraction = (wetDensity - line_prev) / (line_i - line_prev)`
   - `dryDensity = boundary[i-1] + fraction * (boundary[i] - boundary[i-1])`

---

## Three-View Architecture + 3 Quick-Entry Screens

### Daily Entry — Forms Section (View 1)

A section on the daily entry screen showing linked forms with 3 action buttons.

```
+---------------------------------------------+
|  FORMS                                       |  titleMedium
|  +=========================================+ |
|  |  MDOT 0582B                             | |  Card (surfaceElevated)
|  |  1 proctor · 3 tests · Open             | |  radiusMedium (12)
|  |  Last: Sta 12+50 · 95.0%               | |
|  |  [+ Test]  [+ Proctor]  [+ Weights]     | |  48dp buttons
|  |                          [View Form ->]  | |
|  +=========================================+ |
|  +=========================================+ |
|  |  MDOT 1174R                             | |
|  |  0 tests · Open                         | |
|  |  [+ Test]           [View Form ->]      | |
|  +=========================================+ |
+---------------------------------------------+
```

**Widget**: `EntryFormCard` — shows form type, proctor count, test count, status, last test summary, 3 action buttons + view form.

### Proctor Entry Screen (New — from "+ Proctor")

Focused screen for entering proctor data. Auto-computes MDD/OMC via OnePointCalculator.

```
+---------------------------------------------+
|  <- Back     NEW PROCTOR -> 0582B       #2   |  AppBar
+----- ----------------------------------------+
|                                              |
|  +- PROCTOR DATA ---- accentAmber ----------+|
|  |  Moisture %       [17.3    ]              ||  56dp input
|  |  Volume Mold      [0.0333  ] cuft         ||
|  |  Wet Soil + Mold  [3810    ] g            ||
|  |  Mold             [1640    ] g            ||
|  +-------------------------------------------+|
|                                              |
|  +- CALCULATED ---- surfaceHighlight -------+|
|  |  Wet Soil     = 2170 g      (calc)        ||  italic
|  |  Wet Soil     = 4.78 lbs    (calc)        ||
|  |  Wet PCF      = 143.6       (calc)        ||
|  +-------------------------------------------+|
|                                              |
|  +- ONE-POINT CHART RESULT -- statusInfo ---+|
|  |  Max Density  = 103.4 pcf   (auto)        ||  bold, green
|  |  Opt Moisture = 19.6%       (auto)        ||  bold, green
|  +-------------------------------------------+|
|                                              |
|  +-------------------------------------------+|
|  |         SAVE PROCTOR                       ||  ElevatedButton
|  |         primaryCyan, 56dp, full width      ||
|  +-------------------------------------------+|
+----------------------------------------------+
```

**Key behaviors:**
- Auto-compute triggers as soon as all 4 inputs + moisture% have values
- If inputs outside chart bounds (moisture <5% or >20%, or wet density out of range): show inline warning, MDD/OMC show "--", Save button **disabled**
- On save: append to FormResponse.proctor_rows, navigate back to daily entry
- Proctor number auto-assigned sequentially

### Quick Test Entry Screen (View 2 — from "+ Test")

Primary data entry surface for a single test row. Three groups matching PDF columns.

```
+---------------------------------------------+
|  <- Back     NEW TEST -> 0582B          #4   |  AppBar
+----- ----------------------------------------+
|  Proctor: [* P#1 103.4] [P#2 115.2]         |  Chip bar
+----- ----------------------------------------+
|                                              |
|  +- GAUGE READINGS ---- primaryCyan --------+|
|  |  Original o / Recheck o                   ||
|  |  Test Depth        [      ] in            ||  56dp input
|  |  Counts (MC)  [      ]  Counts (DC) [  ]  ||  side-by-side
|  +-------------------------------------------+|
|                                              |
|  +- DENSITY RESULTS ---- statusInfo --------+|
|  |  Dry Density  [      ] pcf                ||
|  |  Wet Density  [      ] pcf                ||
|  |  Moisture PCF = ___   pcf    (calc)       ||  italic
|  |  Moisture     [      ] %                  ||
|  |  Max Density  = 103.4 pcf   (from P#1)   ||  auto, locked
|  |  % Compaction = ___   %     (calc)        ||  italic
|  +-------------------------------------------+|
|                                              |
|  +- LOCATION ---------- accentAmber --------+|
|  |  Station           [              ]       ||
|  |  Dist. from CL     L [    ]  R [    ] ft  ||
|  |  Depth Below Grade [      ] ft            ||
|  |  Item of Work      [          ] v         ||  dropdown
|  +-------------------------------------------+|
|                                              |
|  +-------------------------------------------+|
|  |         SEND TO FORM                       ||  ElevatedButton
|  |         primaryCyan, 56dp, full width      ||
|  +-------------------------------------------+|
+----------------------------------------------+
```

**Proctor chip bar behaviors:**
- **0 proctors**: Show banner "No proctor on this form yet." with [+ Add Proctor First] button. Send to Form **disabled**.
- **1 proctor**: Auto-selected, chip shown as selected, Max Density auto-fills
- **2+ proctors**: Chips shown, tap to select. Max Density updates when selection changes

**SmartInputBar** (slides up when field tapped):
```
+---------------------------------------------+
|  Wet Density (PCF)                           |  labelLarge
|  [  135.2               ]  [<] [>]  [Done]  |  48dp nav buttons
|                     elevation: 8             |  surfaceElevated
+---------------------------------------------+
```

**Key behaviors:**
- `onFieldSwitch`: commits current value BEFORE switching (fixes BUG-1)
- `onNext`: saves value + advances to next editable field (fixes BUG-2)
- `onDone`: saves value + dismisses bar (fixes BUG-3)
- Calculated fields show italic text, surfaceHighlight bg
- Active field: primaryCyan 2px border highlight (fixes UX-2)
- Human-readable labels ("Wet Density" not "wet_density") (fixes UX-1)

### 20/10 Weights Entry Screen (New — from "+ Weights")

Focused screen for entering 20/10 weight readings, tied to a specific proctor.

```
+---------------------------------------------+
|  <- Back     20/10 WEIGHTS -> 0582B          |  AppBar
+----- ----------------------------------------+
|  Proctor: [* P#1 103.4] [P#2 115.2]         |  Chip bar (if multiple)
+----- ----------------------------------------+
|                                              |
|  +- WEIGHT READINGS ---- statusInfo --------+|
|  |  1st Reading  [3810 ] g                   ||
|  |  2nd Reading  [3818 ] g   check d8 <= 10g ||  statusSuccess
|  |  [+ Add Reading]                          ||  TextButton
|  +-------------------------------------------+|
|                                              |
|  +- VALIDATION ---- surfaceHighlight -------+|
|  |  Status: PASS - consolidation achieved    ||  statusSuccess
|  +-------------------------------------------+|
|                                              |
|  +-------------------------------------------+|
|  |         SAVE WEIGHTS                       ||  ElevatedButton
|  |         primaryCyan, 56dp, full width      ||
|  +-------------------------------------------+|
+----------------------------------------------+
```

**Key behaviors:**
- Start with 2 input fields. "+ Add Reading" adds fields up to 5 max.
- Live delta validation between consecutive readings (delta <= 10g = pass)
- If only 1 proctor exists: auto-selected (no chip bar shown)
- If multiple proctors: chip bar to select which proctor these weights belong to
- On save: writes weights array to the selected proctor row in FormResponse

### Form Viewer Screen (View 3 — from "View Form ->")

PDF-like review/edit view with all sections.

```
+---------------------------------------------+
|  <- Back    MDOT 0582B    [eye PDF] [save]   |  AppBar
|             * Open - 3 tests                 |
+----- ----------------------------------------+
|                                              |
|  +- HEADER ----------------------------------+|
|  |  Date             02/20/2026     (auto)   ||
|  |  Control Section  CS 12345       (auto)   ||
|  |  Job Number       864130         (auto)   ||
|  |  Route/Street     M-37           (auto)   ||
|  |  Gauge Number     T-3440-1234             ||
|  |  Inspector        John Smith     (auto)   ||
|  |  Cert. Number     MI-1234        (auto)   ||
|  |  Phone            517-555-0100   (auto)   ||
|  |  Const. Eng.      Jane Doe       (auto)   ||
|  |  Asst. Eng.       [            ]          ||
|  +-------------------------------------------+|
|                                              |
|  -- IN-PLACE DENSITY ----------------------- -|
|  + TEST #1 ----------- check Sent ----------+|
|  |  Gauge: 6in - MC 2450 - DC 1820          ||  compact view
|  |  Dry 115.8  Wet 135.2  Moist 19.4 pcf    ||
|  |  Max 103.4 (P#1) Comp 95.0%  M% 8.5     ||
|  |  Loc: 12+50  L 5ft  Grade 2ft  HMA       ||
|  +-------------------------------------------+|
|  + TEST #2 ----------- check Sent ----------+|
|  |  ...                                      ||
|  +-------------------------------------------+|
|                                              |
|  -- MAX DENSITY (PROCTOR) ------------------- |
|  + PROCTOR #1 --------------------------------+|
|  |  Moist 17.3%  Vol 0.0333 cuft             ||
|  |  Soil+Mold 3810g  Mold 1640g              ||
|  |  Wet Soil 2170g -> 4.78 lbs   (calc)      ||
|  |  Wet PCF 143.6  Max 103.4  Opt 19.6%      ||
|  |  20/10: 3810g, 3818g  check d8g <= 10g    ||  inline weights
|  +-------------------------------------------+|
|                                              |
|  -- STANDARDS ------------------------------- |
|  +-------------------------------------------+|
|  |  Chart:  Dens [    ]  Moist [    ]        ||
|  |  Oper:   Dens [    ]  Moist [    ]        ||
|  +-------------------------------------------+|
|                                              |
|  -- REMARKS --------------------------------- |
|  +-------------------------------------------+|
|  |  [                                    ]   ||  multi-line
|  +-------------------------------------------+|
+----------------------------------------------+
```

**All test rows and proctor rows always editable** — tap any field to change it. Recalculations trigger live.

---

## Data Model

### FormResponse.responseData JSON Schema (v2)

```json
{
  "test_rows": [
    {
      "test_number": 1,
      "proctor_number": 1,
      "is_recheck": false,
      "test_depth_in": "6",
      "counts_mc": "2450",
      "counts_dc": "1820",
      "dry_density_pcf": "115.8",
      "wet_density_pcf": "135.2",
      "moisture_pcf": "19.4",
      "moisture_percent": "8.5",
      "max_density_pcf": "103.4",
      "percent_compaction": "95.0",
      "station": "12+50",
      "distance_left_ft": "5",
      "distance_right_ft": "",
      "depth_below_grade_ft": "2",
      "item_of_work": "HMA"
    }
  ],
  "proctor_rows": [
    {
      "test_number": 1,
      "moisture_percent": "17.3",
      "volume_mold_cuft": "0.0333",
      "wet_soil_mold_g": "3810",
      "mold_g": "1640",
      "wet_soil_g": "2170",
      "wet_soil_lbs": "4.78",
      "compacted_wet_pcf": "143.6",
      "max_density_pcf": "103.4",
      "optimum_moisture_pct": "19.6",
      "weights_20_10": ["3810", "3818"]
    }
  ],
  "chart_standards": { "density": "", "moisture": "" },
  "operating_standards": { "density": "", "moisture": "" },
  "remarks": ""
}
```

**Key changes from v1:**
- `proctor_rows[].weights_20_10` — 20/10 weights moved into proctor (was top-level `weights_20_10` array)
- `test_rows[].proctor_number` — links test to specific proctor
- `proctor_rows[].max_density_pcf` / `optimum_moisture_pct` — auto-computed by OnePointCalculator (was manual entry)
- Top-level `weights_20_10` removed

### FormResponse.headerData JSON Schema (unchanged from v1)

```json
{
  "date": "2026-02-20",
  "control_section_id": "CS 12345",
  "job_number": "864130",
  "route_street": "M-37",
  "gauge_number": "T-3440-1234",
  "inspector": "John Smith",
  "cert_number": "MI-1234",
  "phone": "517-555-0100",
  "construction_eng": "Jane Doe",
  "asst_eng": ""
}
```

### Auto-Fill Sources

| Field | Source | New Field? |
|-------|--------|------------|
| Date | `DateTime.now()` | No |
| Job Number | `project.projectNumber` | No |
| Control Section ID | `project.controlSectionId` | Yes — add to Project model |
| Route/Street | `project.routeStreet` | Yes — add to Project model |
| Inspector | `PreferencesService.inspectorName` | No |
| Cert. Number | `PreferencesService.inspectorCertNumber` | No (exists) |
| Phone | `PreferencesService.inspectorPhone` | No (exists) |
| Construction Eng. | `project.constructionEng` | Yes — add to Project model |
| Gauge Number | `PreferencesService.gaugeNumber` | Yes — add to prefs |

### "Send to Form" Flow

```
Inspector taps "Send to Form" on Quick Test Entry
  |
  +-- Validate: proctor selected + minimum Wet Density present
  +-- Run calculations (Moisture PCF, % Compaction)
  +-- Copy Max Density from selected proctor
  +-- Assign test_number = next sequential
  +-- Set proctor_number = selected proctor's test_number
  +-- Append row to FormResponse.test_rows
  +-- Save FormResponse to SQLite
  +-- Show snackbar: "Test #4 sent to 0582B"
  +-- Return to daily entry (form card updates count)
```

---

## Existing Code Reference

| Component | Path | Status |
|-----------|------|--------|
| Calculator | `lib/features/toolbox/data/services/mdot_0582b_calculator.dart` | Basic (moisturePcf + percentCompaction only). Needs OnePointCalculator + proctor calcs |
| FormResponse model | `lib/features/toolbox/data/models/form_response.dart` | Has headerData/responseData JSON. Needs proctor_number in test_rows, weights in proctor |
| Form widget | `lib/features/toolbox/presentation/widgets/mdot_0582b_form_widget.dart` | Basic header + table. Rewrite to FormViewerScreen |
| SmartInputBar | `lib/features/toolbox/presentation/widgets/smart_input_bar.dart` | Has BUG-1,2,3. Fix during Phase 3 |
| Form fill screen | `lib/features/toolbox/presentation/screens/form_fill_screen.dart` | Rewrite to FormViewerScreen |
| Entry forms section | `lib/features/entries/presentation/widgets/entry_forms_section.dart` | Exists. Update to 3-button EntryFormCard |
| Form attachment mgr | `lib/features/entries/presentation/controllers/form_attachment_manager.dart` | Existing controller for form-entry linking |
| Daily entry screen | `lib/features/entries/presentation/screens/entry_editor_screen.dart` | Will host updated forms section |
| Project model | `lib/features/projects/data/models/project.dart` | Needs: controlSectionId, routeStreet, constructionEng |
| PreferencesService | `lib/shared/services/preferences_service.dart` | Needs: certNumber, phone, gaugeNumber |
| AutoFillService | `lib/features/toolbox/data/services/auto_fill_service.dart` | Needs update for all 10 header fields |
| FormPdfService | `lib/features/toolbox/data/services/form_pdf_service.dart` | Needs multi-proctor weight-to-remarks logic |
| FormResponseRepo | `lib/features/toolbox/data/repositories/form_response_repository.dart` | May need updates for new query patterns |
| Router | `lib/core/router/app_router.dart` | Add routes for 3 new screens |
| Forms list screen | `lib/features/toolbox/presentation/screens/forms_list_screen.dart` | Exists in Toolbox |

---

## Bug Fixes (Folded Into Architecture)

| Bug | Root Cause | Fix |
|-----|-----------|-----|
| BUG-1: Value lost on cell switch | No commit before switch | SmartInputBar `onFieldSwitch` calls `_commitCurrentValue()` first |
| BUG-2: Next doesn't advance | `_applySmartInput` never updates active field index | Ordered field list; `onNext` saves + advances index past calc fields |
| BUG-3: Done unresponsive | State race on widget rebuild | Commit then dismiss in `Future.microtask`; stable ValueKeys |
| BUG-4: PDF template missing | Wrong asset path | Fix to `assets/templates/forms/mdot_0582b_form.pdf` (exists); implement field-filling |
| BUG-5: No saved form list | Forms list only shows "New" | "View Form" on daily entry card; also add forms list to Toolbox |

## UX Fixes (Folded Into Architecture)

| Issue | Fix |
|-------|-----|
| UX-1: Raw field keys | Human-readable labels in SmartInputBar + all sections |
| UX-2: No selected cell highlight | Active field gets primaryCyan 2px border |
| UX-3: Calc vs editable look same | Calc fields: surfaceHighlight bg, italic |
| UX-4: No row numbers | "TEST #N" / "PROCTOR #N" header on every card |
| UX-5: Labels disappear | Persistent labels — label stays left, value right |
| UX-6: Not field-ready | Full redesign with section grouping, accent colors, 56dp inputs |

---

## Design Tokens Used

| Element | Token | Value |
|---------|-------|-------|
| Section accent (Gauge) | `primaryCyan` | #00BCD4 |
| Section accent (Density) | `statusInfo` | #2196F3 |
| Section accent (Location/Proctor) | `accentAmber` | #FFC107 |
| Card background | `surfaceElevated` | dark: #1E1E2E |
| Calculated field bg | `surfaceHighlight` | dark: #2A2A3E |
| Active field border | `primaryCyan` | 2px, matches focusedBorder |
| Input height | `touchTargetComfortable` | 56dp |
| Button min height | `touchTargetMin` | 48dp |
| Card radius | `radiusMedium` | 12 |
| Spacing between sections | `space8` | 24 |
| Spacing within sections | `space4` | 8 |
| Status badge (sent) | `statusSuccess` | #4CAF50 |
| Auto-fill indicator | `textTertiary` | "(auto)" suffix |
| Calculated text | `textSecondary` + italic | "(calc)" suffix |
| Auto-computed (OnePoint) | `statusSuccess` + bold | "(auto)" suffix, green |
| Chip selected | `primaryCyan` | filled chip |
| Chip unselected | `surfaceElevated` | outlined chip |
| Validation pass | `statusSuccess` | green check icon |
| Validation fail | `statusError` | red warning icon |
| Out-of-bounds warning | `statusWarning` | amber warning icon |

---

## Implementation Phases

### Phase 1: OnePointCalculator + Data Model
**Goal**: Port the Michigan Cone algorithm to Dart and expand the data model.

**Build**:
- New `OnePointCalculator` class in `lib/features/toolbox/data/services/one_point_calculator.dart`
  - 21-row lookup table (slopes, intercepts, boundaryDD)
  - Cubic polynomial for OMC
  - Validation polynomial for upper bounds
  - `compute(moisturePercent, compactedWetPcf)` -> `{ maxDensityPcf, optimumMoisturePct }` or validation error
- Expand `Mdot0582BCalculator` — add proctor calcs (F=D-E, G=F/453.59, H=G/C)
- Expand `FormResponse` responseData JSON schema to v2 (proctor_number in test_rows, weights in proctor_rows)
- Add new `PreferencesService` field: gaugeNumber (certNumber and phone already exist as inspectorCertNumber and inspectorPhone)
- Add new `Project` model fields: controlSectionId, routeStreet, constructionEng
- Update `AutoFillService` to fill all 10 header fields
- DB migration for new Project columns

**Verify**: Unit tests for OnePointCalculator (all 14 ground truth points), proctor calc chain, 20/10 validation, new field persistence.

**Agent**: `backend-data-layer-agent`

---

### Phase 2: Proctor Entry Screen
**Goal**: Focused screen for proctor data entry with auto-compute MDD/OMC.

**Build**:
- New `ProctorEntryScreen` with 4 input fields + auto-compute section
- Wire OnePointCalculator: auto-compute triggers when moisture% + compacted wet PCF are available
- Calculated fields (wet soil, wet lbs, wet PCF) update live
- Out-of-bounds: inline warning, MDD/OMC show "--", Save disabled
- Route registration in `app_router.dart`
- Navigation from daily entry form card "[+ Proctor]"
- On save: append to FormResponse.proctor_rows, navigate back

**Verify**: Unit tests for validation states. Manual test: enter valid proctor data, see MDD/OMC auto-compute, save.

**Agent**: `frontend-flutter-specialist-agent` + `interface-design` skill

---

### Phase 3: Quick Test Entry Screen
**Goal**: Primary data entry surface with proctor linking.

**Build**:
- Rewrite Quick Test Entry with proctor chip bar
- 3 sections: Gauge Readings, Density Results, Location
- Proctor chip bar: auto-select if 1, picker if multiple
- No-proctor state: banner "No proctor yet" + [Add Proctor First] button, Send to Form disabled
- Max Density auto-fills from selected proctor
- % Compaction auto-calculates
- Updated `SmartInputBar` — fix BUG-1 (auto-commit), BUG-2 (next advancement), BUG-3 (done stability)
- Updated `FormFieldCell` — persistent label + value, active highlight
- "Send to Form" action with validation, calculation, proctor linking
- Route registration + navigation

**Verify**: dart-mcp — open from daily entry, select proctor, fill all three groups, verify calcs, send to form, confirm snackbar.

**Agent**: `frontend-flutter-specialist-agent` + `interface-design` skill

---

### Phase 4: 20/10 Weights Entry Screen
**Goal**: Per-proctor weight entry with live validation.

**Build**:
- New `WeightsEntryScreen` with proctor picker (chip bar if multiple)
- 2 input fields initially + "[+ Add Reading]" up to 5
- Live delta validation (consecutive pair delta <= 10g = pass/fail)
- Pass/fail status display
- On save: writes weights array to selected proctor row in FormResponse
- Route registration + navigation from daily entry "[+ Weights]"

**Verify**: Enter 2 weights with delta <= 10g, verify pass. Add 3rd weight with delta > 10g, verify fail. Save and verify data persisted.

**Agent**: `frontend-flutter-specialist-agent`

---

### Phase 5: Form Viewer + Daily Entry Integration
**Goal**: PDF-like review screen + updated daily entry form cards.

**Build**:
- Rewrite `FormFillScreen` -> `FormViewerScreen`
- New section widgets: `FormHeaderViewer`, `TestRowCard`, `ProctorCard`, `StandardsSection`, `RemarksSection`
- All rows always editable (tap any field)
- Live recalculation on edit
- Status badges on test rows (sent)
- Proctor cards show inline 20/10 weights summary
- New `EntryFormCard` widget with 3 action buttons (+ Test, + Proctor, + Weights) + View Form
- Wire all navigation from daily entry to 3 entry screens + form viewer
- Preview PDF / Save / Export buttons in AppBar

**Verify**: dart-mcp — view form with 3 tests + 2 proctors, all data displays correctly, edit inline, verify recalc.

**Agent**: `frontend-flutter-specialist-agent` + `interface-design` skill

---

### Phase 6: PDF + Polish
**Goal**: Working PDF preview/export and remaining polish.

**Build**:
- Fix PDF template path -> `assets/templates/forms/mdot_0582b_form.pdf`
- Implement PDF field-filling with all 16 test columns + proctor + header
- Multi-proctor weight handling: latest proctor's weights in 5-slot table, older proctors' weights auto-appended to Remarks as "Proctor #N 20/10: 1) xxxx 2) xxxx"
- Add saved forms list to Toolbox screen
- Unsaved changes prompt on form viewer navigate-away
- Required fields validation on export
- Status transitions (open -> submitted -> exported)

**Verify**: Generate PDF preview, verify all fields populate including multi-proctor weights in remarks. Full E2E flow test.

**Agent**: `pdf-agent` + `qa-testing-agent`

---

## Agent Assignments

| Phase | Primary Agent | Support |
|-------|--------------|---------|
| Phase 1: Calculator + Data Model | backend-data-layer-agent | — |
| Phase 2: Proctor Entry | frontend-flutter-specialist-agent | interface-design skill |
| Phase 3: Quick Test Entry | frontend-flutter-specialist-agent | interface-design skill |
| Phase 4: Weights Entry | frontend-flutter-specialist-agent | — |
| Phase 5: Form Viewer + Daily Entry | frontend-flutter-specialist-agent | interface-design skill |
| Phase 6: PDF + Polish | pdf-agent | qa-testing-agent |

---

## Future Work (Not in This Plan)

- **T-99 Chart Support**: Algorithm decoded and tables available in `tools/mdot-apk/decoded_algorithm.md`. Add chart type selector + T-99 tables if needed.
- **1174R Form**: Apply same three-view architecture to concrete form.
- **Form Templates**: Support for additional MDOT forms beyond 0582B/1174R.
- **Proctor Data Carry-Forward**: When soil type doesn't change, carry forward proctor values from previous form.
- **Gauge Bluetooth Integration**: Read values directly from Troxler 3440 / InstroTek 3500 via Bluetooth.
- **Manual MDD Override**: Allow inspector to override auto-computed MDD with lab-tested value (edge case for unusual soils).

---

## Reference Documents

- MDOT Density Testing and Inspection Manual 2024: `Pre-devolopment and brainstorming/Form Templates for export/Density-Testing-Inspection-Manual.pdf`
- MDOT Form 0582B: `assets/templates/forms/mdot_0582b_form.pdf`
- Decoded MDOT Algorithm: `tools/mdot-apk/decoded_algorithm.md`
- Chart Digitization Research: `tools/chart-digitization-research.md`
- One-Point Michigan Cone Chart (high-res): `Pre-devolopment and brainstorming/Form Templates for export/CONEBLU-MDOT-Chart.pdf`
- Previous plan (v1): This file, Session 418
- Previous plan (phases 3-6): `.claude/plans/2026-02-20-0582b-form-redesign.md`
- Test findings: `.claude/test-results/2026-02-21-0582b-form-testing-findings.md`
