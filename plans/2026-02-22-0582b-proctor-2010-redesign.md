# 0582B Proctor + 20/10 Redesign — Implementation Plan

**Date:** 2026-02-22
**Status:** Approved — Ready to build
**Supersedes:** Portions of `2026-02-21-0582b-hub-screen-design.md` (Phases 3, 5, 6 are replaced; Phases 1, 2, 4, 7 need updates)
**Mockup:** Prototyped via html-sync + Playwright (Session 442). A+E combo approved.

---

## Problem Statement

The current 0582B hub screen has the flow wrong:

**Current (wrong):** Header → Proctor → Quick Test → Weights (20/10)
**Correct:** Header → Proctor (with 20/10 built in) → Quick Test

The 20/10 consolidation process is NOT a separate verification step — it IS the core of the proctor procedure. The inspector performs successive compaction rounds (20 blows each), weighing after each round, until consecutive weights converge within 10g. The **final converged weight** is the Wet Soil+Mold value that feeds into the MDD/OMC one-point calculation.

---

## Brainstorming Decisions (Session 442)

| Decision | Choice | Rationale |
|----------|--------|-----------|
| 20/10 placement | **Merged into proctor section** | 20/10 IS the proctor procedure, not a separate step. Final weight drives MDD calc. |
| Section count | **3 sections** (Header, Proctor, Quick Test) | Weights section removed entirely. |
| Chart type selector | **Removed** | Algorithm handles it internally — no user selection needed, matching MDOT Construction Density APK behavior. |
| Completion concept | **Removed** | Form is always open for more proctors/tests. No completion state, no CompletionBanner. |
| Preview PDF availability | **After header confirmed** | Available in app bar whenever the form has been saved with a confirmed header. |
| Weight readings model | **Sequential list** (not pairs) | Delta calculated between consecutive readings. Unlimited count (commonly 3-5, sometimes 7-8). |
| First reading | **Entered by user** | First weight reading is the initial compaction weight. |
| MDD calculation source | **Final weight in list** | Last entered weight (which should be the converged one) feeds into Wet Soil+Mold → MDD calc chain. |
| 20/10 gating | **No gate** | Delta pass/fail is informational only. Inspector can SEND regardless — sometimes convergence is hard and they proceed anyway. Extra readings go in Remarks on PDF. |
| Proctor layout | **A+E combo** | LIVE MDD/OMC card pinned at top + Setup fields + 20/10 readings + Full calculated card at bottom. |
| Previously sent proctor | **Compact summary** | Same pattern as "Last Sent" in quick test section. |
| Proctor-to-test linking | **Existing chip bar** | Already implemented in quick test section. No changes needed. |

---

## Corrected Proctor Section Layout

```
┌──────────────────────────────────┐
│ Proctor #1              ▼       │  ← Accordion header
├──────────────────────────────────┤
│ ┌──────────────────────────────┐ │
│ │ LIVE   MDD 103.4  OMC 19.6% │ │  ← LIVE result card (updates on every reading)
│ │        Wet PCF: 144.5        │ │     From Reading #3: 3824g
│ └──────────────────────────────┘ │
│                                  │
│ SETUP                            │
│ ┌──────────┬──────────┬────────┐ │
│ │Moisture %│ Vol Mold │Mold (g)│ │  ← 3 setup inputs (no chart type)
│ │  17.3    │  0.0333  │  1640  │ │
│ └──────────┴──────────┴────────┘ │
│                                  │
│ 20/10 WEIGHTS (WET SOIL + MOLD)  │
│ 1.  [3810]                       │  ← First reading (initial compaction)
│ 2.  [3818]            Δ 8g      │  ← Delta from previous
│ 3.  [3824]            Δ 6g ✓   │  ← Converged (≤ 10g), green highlight
│     [+ Add Reading]              │
│                                  │
│ CALCULATED (FROM READING #3)     │
│ ┌──────────────────────────────┐ │
│ │ Wet Soil: 2184g  Lbs: 4.81  │ │  ← Full calc chain visible
│ │ Wet PCF: 144.5               │ │
│ │ ─────────────────────────── │ │
│ │ MDD: 103.4 pcf  OMC: 19.6% │ │  ← Final result (matches LIVE card)
│ └──────────────────────────────┘ │
│                                  │
│ [      SEND TO FORM       ]      │  ← Sends proctor + all 20/10 weights
└──────────────────────────────────┘
```

---

## Data Model Changes

### proctor_rows (updated structure)

```json
{
  "test_number": 1,
  "proctor_number": 1,
  "moisture_percent": "17.3",
  "volume_mold_cuft": "0.0333",
  "mold_g": "1640",
  "weights_20_10": ["3810", "3818", "3824"],
  "wet_soil_mold_g": "3824",
  "wet_soil_g": "2184",
  "wet_soil_lbs": "4.81",
  "compacted_wet_pcf": "144.5",
  "max_density_pcf": "103.4",
  "optimum_moisture_pct": "19.6"
}
```

**Key change**: `wet_soil_mold_g` is now derived from the LAST entry in `weights_20_10`, not a separate user input. The `weights_20_10` array stores ALL readings as sequential values (not pairs).

### Removed fields
- `chart_type` — removed from proctor row and hub state

### Unchanged
- `test_rows` structure — no changes
- `headerData` structure — no changes

---

## Widget Changes

### Files to modify

| File | Change |
|------|--------|
| `widgets/hub_proctor_content.dart` | **Major rewrite** — New layout: LIVE card + setup (3 fields, no chart type) + sequential weight readings + full calc card. Remove chart type dropdown. Remove separate Wet Soil+Mold input (now comes from 20/10 final weight). |
| `screens/mdot_hub_screen.dart` | Remove Section 3 (Weights) entirely. Change from 4 sections to 3. Remove `_weightsStatus`. Remove weights-related state. Update `_expandedSection` logic. Remove completion logic (`_isComplete`, `CompletionBanner`). Make Preview PDF available after header confirmed. |
| `widgets/status_pill_bar.dart` | Remove Weights pill. Only 3 pills: Header, P#N, Test #N. |

### Files to delete

| File | Reason |
|------|--------|
| `widgets/hub_weights_content.dart` | Weights merged into proctor section |
| `widgets/completion_banner.dart` | No completion concept |

### Files unchanged

| File | Why |
|------|-----|
| `widgets/form_accordion.dart` | Reusable, no changes needed |
| `widgets/summary_tiles.dart` | Reusable, no changes needed |
| `widgets/hub_header_content.dart` | No changes to header flow |
| `widgets/hub_quick_test_content.dart` | No changes to quick test flow (proctor chip bar already works) |

---

## State Design Changes

### Removed state
```dart
// DELETE these from _MdotHubScreenState:
String _chartType = 'T-99';          // No chart type selector
late final _wetSoilMoldCtrl;          // Now derived from 20/10 final weight
List<(TextEditingController, TextEditingController)> _weightPairs;  // Old pairs model
DateTime? _weightsSentAt;             // No separate weights section
bool get _isComplete;                 // No completion concept
SectionStatus get _weightsStatus;     // No weights pill
```

### New/changed state
```dart
// ADD/CHANGE in _MdotHubScreenState:

// === Section control (3 sections, not 4) ===
int _expandedSection = 0; // 0=Header, 1=Proctor, 2=Test, -1=none
final _sectionKeys = List.generate(3, (_) => GlobalKey());

// === Proctor fields (CHANGED) ===
late final _moistureCtrl, _volumeCtrl, _moldCtrl;  // 3 setup fields (no wetSoilMold)
List<TextEditingController> _weightReadings = [];    // Sequential 20/10 readings
Map<String, dynamic>? _proctorCalcResult;
int _proctorNumber = 1;
Map<String, dynamic>? _lastSentProctor;  // For compact summary display

// === Derived from weights ===
String? get _finalWeight =>
    _weightReadings.isNotEmpty ? _weightReadings.last.text : null;
// _finalWeight feeds into calc chain as wet_soil_mold_g
```

### Key methods (changed)

| Method | Change |
|--------|--------|
| `_recalcProctor()` | Now reads `_finalWeight` (last 20/10 reading) as wet_soil_mold_g. Recalcs on every weight reading change, not just the 4 input fields. LIVE card updates immediately. |
| `_sendProctor()` | Collects: 3 setup fields + full `_weightReadings` list + all calculated fields. Stores `wet_soil_mold_g` = last reading. Stores `weights_20_10` = all readings. No separate weights send needed. |
| `_addWeightReading()` | Adds a new `TextEditingController` to `_weightReadings` list. No max limit (but typically 3-8). |
| `_sendWeights()` | **DELETED** — no longer exists. |
| `_expandSection()` | Only handles indices 0-2 (Header, Proctor, Test). |

### Derived status (simplified)

```dart
// 3 pills only
SectionStatus get _headerStatus => _headerConfirmed
    ? SectionStatus.sent : SectionStatus.entering;
SectionStatus get _proctorStatus => _lastSentProctor != null
    ? SectionStatus.sent
    : _expandedSection == 1 ? SectionStatus.entering : SectionStatus.pending;
SectionStatus get _testStatus => _lastSentTest != null
    ? SectionStatus.sent
    : _expandedSection == 2 ? SectionStatus.entering : SectionStatus.pending;
// No _weightsStatus
```

---

## Proctor Section Internal Layout (hub_proctor_content.dart)

### Widget tree

```
HubProctorContent (StatelessWidget, receives callbacks + data)
├── LIVE MDD/OMC Card
│   ├── Row: MDD value + OMC value (15px, bold)
│   ├── Subtitle: "Wet PCF: X · From Reading #N"
│   └── LIVE badge (green, top-right)
│   └── Shows "--" if no valid calc yet
│
├── Section label: "SETUP"
├── Row(3 fields): Moisture % | Vol Mold (cuft) | Mold (g)
│
├── Section label: "20/10 WEIGHTS (WET SOIL + MOLD)"
├── For each reading in _weightReadings:
│   ├── Row: index label + TextFormField + delta chip (if index > 0)
│   │   └── Delta chip:
│   │       - Amber background: "Δ Xg" (when > 10g)
│   │       - Green background: "Δ Xg ✓" (when ≤ 10g)
│   │       - Empty for first reading (no previous to compare)
│   └── Final reading has green border when converged
├── "+ Add Reading" dashed button
│
├── Section label: "CALCULATED (FROM READING #N: XXXXg)"
├── Calculated card (green border):
│   ├── Row: Wet Soil (g) | Wet Soil (lbs) | Wet PCF
│   ├── Divider
│   └── Row: MDD (pcf) | OMC (%)
│
└── "SEND TO FORM" button (enabled when MDD is valid)
```

### Calculation flow

```
User enters setup fields (Moisture%, Vol Mold, Mold)
                ↓
User enters weight readings (3810, 3818, 3824...)
                ↓
On EVERY reading change:
  finalWeight = last non-empty reading
  wetSoilG = finalWeight - moldG
  wetSoilLbs = wetSoilG / 453.59
  compactedWetPcf = wetSoilLbs / volumeMold
  (maxDensityPcf, optimumMoisturePct) = OnePointCalculator(moisture%, compactedWetPcf)
                ↓
LIVE card updates: MDD, OMC, "From Reading #N"
Calculated card updates: all intermediate + final values
Delta chips update: |reading[i] - reading[i-1]|
```

### Delta chip behavior

- Reading 1: No chip (nothing to compare to)
- Reading 2+: `Δ = |reading[N] - reading[N-1]|`
  - `Δ ≤ 10g`: Green chip "Δ Xg ✓"
  - `Δ > 10g`: Amber chip "Δ Xg"
- Delta is informational only — does NOT gate SEND

### SEND validation

SEND enabled when:
- `_finalWeight` is non-empty (at least 1 reading)
- `maxDensityPcf != null` (one-point calc succeeded)
- `moisture%`, `volumeMold`, `moldG` are all filled

### Previously sent proctor display

After sending Proctor #1, if user adds Proctor #2:
- Compact summary card appears at top of proctor section:
  ```
  P#1 · MDD 103.4 · OMC 19.6% · 3 readings
  ```
- Fresh empty fields appear below for Proctor #2
- Same pattern as "Last Sent" test banner in quick test section

---

## Provider Changes

### Modified method

| Method | Change |
|--------|--------|
| `appendMdot0582bProctorRow()` | Remove `chart_type` from row map. Ensure `wet_soil_mold_g` is set from last weight reading. Ensure `weights_20_10` is the full sequential list. |

### Removed method

| Method | Reason |
|--------|--------|
| `updateMdot0582bProctorWeights()` | No longer needed — weights are included in the proctor row at send time. |

### Unchanged methods

- `appendMdot0582bTestRow()` — no changes
- `updateResponse()` — no changes
- `loadResponseById()` — no changes

---

## Testing Keys Changes

### Remove
```dart
// Delete these keys:
TestingKeys.hubWeightsReading(int index)
TestingKeys.hubWeightsAddButton
TestingKeys.hubWeightsSendButton
TestingKeys.hubWeightsDeltaChip(int index)
TestingKeys.hubWeightsSummaryTiles
TestingKeys.hubCompletionBanner
TestingKeys.hubNewTestButton
TestingKeys.hubProctorChartType
```

### Add
```dart
// New keys for integrated proctor + 20/10:
TestingKeys.hubProctorLiveCard          // LIVE MDD/OMC card at top
TestingKeys.hubProctorSetupField(String) // 'moisture_pct', 'volume_mold', 'mold_g'
TestingKeys.hubProctorWeightReading(int) // 0-indexed, unlimited
TestingKeys.hubProctorWeightDelta(int)   // Delta chip per reading (index 1+)
TestingKeys.hubProctorAddReading         // "+ Add Reading" button
TestingKeys.hubProctorCalcCard           // Bottom calculated card
TestingKeys.hubProctorLastSent           // Previously sent proctor summary
TestingKeys.hubPreviewPdfButton          // In app bar, available after header confirmed
```

### Unchanged
```dart
// These stay as-is:
TestingKeys.hubSection(String)
TestingKeys.hubSectionHeader(String)
TestingKeys.hubSectionBadge(String)
TestingKeys.hubHeaderField(String)
TestingKeys.hubConfirmHeaderButton
TestingKeys.hubProctorSendButton
TestingKeys.hubProctorSummaryTiles
TestingKeys.hubTestField(String)
TestingKeys.hubTestSendButton
TestingKeys.hubTestLastSentBanner
TestingKeys.hubTestSummaryTiles
```

---

## Build Phases

### Phase 1: Delete weights section + completion banner

1. Delete `widgets/hub_weights_content.dart`
2. Delete `widgets/completion_banner.dart`
3. In `mdot_hub_screen.dart`:
   - Remove Section 3 (Weights accordion)
   - Remove all weights-related state (`_weightPairs`, `_weightsSentAt`, `_weightsStatus`)
   - Remove completion logic (`_isComplete`, `CompletionBanner` widget)
   - Change section count from 4 to 3
   - Update `_expandedSection` auto-advance: after proctor → Test (index 2, was 2 anyway)
4. In `status_pill_bar.dart` usage: Remove Weights pill
5. In `widgets.dart` barrel: Remove exports for deleted files
6. Make Preview PDF button in AppBar visible after `_headerConfirmed` (not after completion)
7. Remove `chart_type` dropdown and state from proctor section
8. Run `flutter analyze` — 0 issues

### Phase 2: Rewrite proctor section with 20/10 integration

1. Rewrite `widgets/hub_proctor_content.dart` with new layout:
   - LIVE MDD/OMC card at top
   - 3 setup fields (Moisture%, Vol Mold, Mold) — no chart type, no Wet Soil+Mold input
   - Sequential weight readings list with delta chips
   - "+ Add Reading" button (no limit)
   - Full calculated card at bottom
   - SEND TO FORM button
2. In `mdot_hub_screen.dart`:
   - Replace weight pairs state with `List<TextEditingController> _weightReadings`
   - Update `_recalcProctor()` to use last weight reading as wet_soil_mold_g
   - Update `_sendProctor()` to include all weight readings in proctor row
   - Add `_addWeightReading()` method
   - Add `_lastSentProctor` state for compact summary
   - Wire LIVE card to recalc results
3. Initialize with 2 empty readings by default (inspector always has at least 1-2)
4. Run `flutter analyze` — 0 issues

### Phase 3: Provider cleanup + data model alignment

1. In `inspector_form_provider.dart`:
   - Update `appendMdot0582bProctorRow()`: remove `chart_type`, ensure `wet_soil_mold_g` comes from weights
   - Remove `updateMdot0582bProctorWeights()` method (no longer needed)
2. Update testing keys:
   - Remove old weights/completion keys from `toolbox_keys.dart` + `testing_keys.dart`
   - Add new proctor 20/10 keys
3. Update barrel files if needed
4. Run `flutter analyze` + `flutter test` — all green

### Phase 4: Polish + verify

1. Verify previously sent proctor compact summary works for multi-proctor flow
2. Verify proctor-to-test linking (chip bar in quick test) still works correctly
3. Verify PDF generation includes 20/10 weight data correctly
4. Smooth scroll animation on section transitions
5. Resume state on re-open (if partial 20/10 data exists, restore readings)
6. Run full `flutter test` suite — all green
7. Manual UX pass on the new flow

---

## Risks & Mitigations

| Risk | Likelihood | Mitigation |
|------|------------|------------|
| Dynamic weight readings list grows large (7-8 items) | Medium | ListView inside accordion handles scroll. Test with 8 readings. |
| LIVE card flickers during rapid typing | Low | Debounce recalc with 150ms delay or use `onEditingComplete`. |
| PDF generation expects old weights structure | Medium | Check `form_pdf_service.dart` for `weights_20_10` format assumptions. Sequential list should be compatible. |
| Old saved forms have `chart_type` field | Low | Ignore on load — field is simply not used. No migration needed. |
| Previously sent proctor summary + new proctor fields UX | Medium | Match existing "Last Sent" test pattern exactly. |

---

## Agent Assignments

| Phase | Agent | Notes |
|-------|-------|-------|
| Phase 1 | `frontend-flutter-specialist-agent` | Delete files, strip weights/completion, simplify to 3 sections |
| Phase 2 | `frontend-flutter-specialist-agent` | Core rewrite — new proctor layout with 20/10 integration |
| Phase 3 | `frontend-flutter-specialist-agent` | Provider cleanup, testing keys, data model |
| Phase 4 | `qa-testing-agent` + `code-review-agent` | Polish, verify, test |

---

## Reference

- **Mockup (A+E combo):** html-sync page from Session 442
- **Previous plan:** `.claude/plans/2026-02-21-0582b-hub-screen-design.md`
- **Decoded algorithm:** `tools/mdot-apk/decoded_algorithm.md`
- **One-point calculator:** `lib/features/forms/data/services/one_point_calculator.dart`
- **Current proctor widget:** `lib/features/forms/presentation/widgets/hub_proctor_content.dart`
- **Current hub screen:** `lib/features/forms/presentation/screens/mdot_hub_screen.dart`
